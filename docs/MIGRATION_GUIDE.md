# Alembic Migration Guide

## Overview

Alembic is now set up for database migrations. This allows you to:
- Track database schema changes
- Apply migrations in order
- Rollback migrations if needed
- Work with teams on schema changes

## Initial Setup

Alembic has been initialized and configured:
-  `alembic.ini` - Configuration file
-  `alembic/env.py` - Migration environment (configured to use DATABASE_URL)
-  `alembic/versions/` - Migration files directory

## Migration Commands

### Check Current Migration Status
```bash
alembic current
```

### View Migration History
```bash
alembic history
```

### Apply All Pending Migrations
```bash
alembic upgrade head
```

### Apply Specific Migration
```bash
alembic upgrade <revision_id>
```

### Rollback One Migration
```bash
alembic downgrade -1
```

### Rollback to Specific Revision
```bash
alembic downgrade <revision_id>
```

### Create New Migration
```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "Description of changes"

# Create empty migration (manual)
alembic revision -m "Description of changes"
```

## First Time Setup

### 1. Clean Database (Recommended for New Deployments)

If you're starting with a **clean/empty database**:

```bash
# Apply the initial migration (creates ALL tables)
alembic upgrade head
```

This will create all tables:
-  companies
-  vendors
-  buyers
-  journal_entries
-  journal_entry_lines
-  invoices
-  bank_transactions
-  reconciliations
-  users

### 2. Existing Database with Tables

If you already have tables created via `init_db.py`:

**Option A: Keep existing tables, add users only**
```bash
# Create migration for just users table
alembic revision --autogenerate -m "Add users table"
alembic upgrade head
```

**Option B: Start fresh with migrations ( Deletes all data!)**
```bash
# Drop all tables, then apply initial migration
alembic downgrade base  # If you have migrations applied
# Or manually drop tables, then:
alembic upgrade head
```

**Option C: Mark existing state as baseline**
```bash
# Stamp the database (tells Alembic tables already exist)
alembic stamp head

# Future changes will be tracked via migrations
```

### 2. Verify Migration

```bash
# Check current revision
alembic current

# Should show: 932d4e7c9fd6 (head)
```

## Common Workflows

### Adding a New Field to a Model

1. **Modify the model** in `database/models.py`:
```python
class User(Base):
    # ... existing fields ...
    phone_number = Column(String, nullable=True)  # New field
```

2. **Generate migration**:
```bash
alembic revision --autogenerate -m "Add phone_number to users"
```

3. **Review the migration file** in `alembic/versions/`:
   - Check that it looks correct
   - Modify if needed (e.g., add data migration)

4. **Apply migration**:
```bash
alembic upgrade head
```

### Creating a New Table

1. **Add model** in `database/models.py`
2. **Generate migration**: `alembic revision --autogenerate -m "Add new_table"`
3. **Review and apply**: `alembic upgrade head`

### Modifying Existing Table

1. **Modify model** in `database/models.py`
2. **Generate migration**: `alembic revision --autogenerate -m "Modify table_name"`
3. **Review migration** (Alembic handles most changes automatically)
4. **Apply migration**: `alembic upgrade head`

## Migration File Structure

Each migration file contains:
- `upgrade()` - Apply the migration
- `downgrade()` - Rollback the migration
- Revision ID - Unique identifier
- Dependencies - Previous migrations

Example:
```python
def upgrade():
    op.add_column('users', sa.Column('phone_number', sa.String(), nullable=True))

def downgrade():
    op.drop_column('users', 'phone_number')
```

## Best Practices

1. **Always review autogenerated migrations** before applying
2. **Test migrations** on a development database first
3. **Backup database** before applying migrations in production
4. **Use descriptive migration messages**: `-m "Add email verification to users"`
5. **Don't edit applied migrations** - create new ones instead
6. **Keep migrations small** - one logical change per migration

## Troubleshooting

### Migration Conflicts

If you have conflicts with existing database:

```bash
# Check what Alembic thinks the current state is
alembic current

# If it shows nothing, stamp it
alembic stamp head

# If tables exist but Alembic doesn't know, you may need to:
# 1. Drop and recreate (development only!)
# 2. Or manually create initial migration matching current state
```

### Autogenerate Not Detecting Changes

- Make sure models are imported in `alembic/env.py`
- Check that `target_metadata = Base.metadata` is set
- Verify model changes are saved

### Database Connection Issues

- Check `DATABASE_URL` in `.env`
- Verify database is running
- Test connection: `psql $DATABASE_URL`

## Integration with Docker

### In docker-compose.yml

The docker-compose.yml can be updated to run migrations on startup:

```yaml
command: >
  sh -c "
    echo 'Running migrations...' &&
    alembic upgrade head &&
    echo 'Starting server...' &&
    uvicorn api.main:app --host 0.0.0.0 --port 8000
  "
```

### Manual Migration in Container

```bash
docker-compose exec app alembic upgrade head
```

## Production Deployment

1. **Backup database** before migrations
2. **Test migrations** on staging first
3. **Apply migrations**:
   ```bash
   alembic upgrade head
   ```
4. **Verify** application works correctly
5. **Monitor** for any issues

## Current Migration

The initial migration (`932d4e7c9fd6_initial_migration_with_users_table.py`) adds:
-  `users` table with all fields
-  Indexes on `user_id` and `email`
-  Foreign key to `companies` table

## Next Steps

1. **Review the migration file** to ensure it's correct
2. **Apply the migration**: `alembic upgrade head`
3. **Verify**: Check that `users` table exists in database
4. **Future changes**: Use `alembic revision --autogenerate` for new changes

