<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper - Users</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- AG Grid Community Edition -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">User Management</h2>
                        <p class="text-sm text-gray-500" id="company-name-nav">Loading...</p>
                    </div>
                    <button onclick="showAddModal()" class="btn-primary">
                        <i class="fas fa-user-plus mr-2"></i>Add User
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div id="users-loading" class="flex items-center justify-center h-32">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading users...</p>
                        </div>
                    </div>
                    
                    <div id="users-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
                    
                    <div id="users-grid-container" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Add New User</h3>
                <button onclick="hideAddModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="add-message" class="mb-4"></div>
            <form id="add-user-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                    <input type="text" id="add-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="add-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="add-role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="accountant">Accountant</option>
                        <option value="viewer">Viewer</option>
                        <option value="admin">Admin</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Only owners can create admin users</p>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="add-send-email" checked class="mr-2">
                    <label for="add-send-email" class="text-sm text-gray-700">Send invitation email</label>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <i class="fas fa-plus mr-2"></i>Create User
                    </button>
                    <button type="button" onclick="hideAddModal()" class="flex-1 btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Edit User</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="edit-message" class="mb-4"></div>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                    <input type="text" id="edit-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="edit-email" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    <p class="text-xs text-gray-500 mt-1">Email cannot be changed</p>
                    <div id="email-verification-status" class="mt-2"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="edit-role" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="accountant">Accountant</option>
                        <option value="viewer">Viewer</option>
                        <option value="admin">Admin</option>
                        <option value="owner">Owner</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="edit-is-active" class="mr-2">
                    <label for="edit-is-active" class="text-sm text-gray-700">Active</label>
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="hideEditModal()" class="flex-1 btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/api.js"></script>
    <script src="/static/sidebar.js"></script>
    <script src="/static/ag-grid-helper.js"></script>
    <script>
        let currentUser = null;
        let users = [];
        let usersGridApi = null;

        async function loadUsers() {
            const loadingEl = document.getElementById('users-loading');
            const errorEl = document.getElementById('users-error');
            const gridContainer = document.getElementById('users-grid-container');

            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            gridContainer.classList.add('hidden');

            try {
                // Get current user to check role
                currentUser = await window.getCurrentUser();
                
                // Load company name
                const company = await window.getCurrentCompany();
                document.getElementById('company-name-nav').textContent = company.name;

                // Load users (only if owner/admin)
                if (currentUser.role !== 'owner' && currentUser.role !== 'admin') {
                    throw new Error('You do not have permission to view users');
                }

                users = await window.getUsers();
                
                // Define column definitions for AG Grid with editable cells
                const columnDefs = [
                    { 
                        field: 'name', 
                        headerName: 'Name',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor'
                    },
                    { 
                        field: 'email', 
                        headerName: 'Email',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: false, // Email cannot be changed
                        flex: 1
                    },
                    { 
                        field: 'role', 
                        headerName: 'Role',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        cellEditor: 'agSelectCellEditor',
                        cellEditorParams: {
                            values: ['owner', 'admin', 'accountant', 'viewer']
                        },
                        cellRenderer: (params) => {
                            const role = params.value || '';
                            const roleUpper = role.toUpperCase();
                            const roleColors = {
                                'owner': 'bg-purple-50 text-purple-700 border border-purple-200',
                                'admin': 'bg-blue-50 text-blue-700 border border-blue-200',
                                'accountant': 'bg-emerald-50 text-emerald-700 border border-emerald-200',
                                'viewer': 'bg-gray-50 text-gray-700 border border-gray-200'
                            };
                            const badgeClass = roleColors[role.toLowerCase()] || 'bg-gray-50 text-gray-700 border border-gray-200';
                            return `<span class="px-2.5 py-0.5 rounded text-xs font-semibold uppercase tracking-wide ${badgeClass}">${escapeHtml(roleUpper)}</span>`;
                        }
                    },
                    { 
                        field: 'is_active', 
                        headerName: 'Status',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        cellEditor: 'agSelectCellEditor',
                        cellEditorParams: {
                            values: [true, false]
                        },
                        cellRenderer: (params) => {
                            const isActive = params.value;
                            const statusText = isActive ? 'ACTIVE' : 'INACTIVE';
                            const badgeClass = isActive 
                                ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' 
                                : 'bg-red-50 text-red-700 border border-red-200';
                            return `<span class="px-2.5 py-0.5 rounded text-xs font-semibold uppercase tracking-wide ${badgeClass}">${statusText}</span>`;
                        }
                    },
                    { 
                        field: 'email_verified', 
                        headerName: 'Email Verified',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: false,
                        cellRenderer: (params) => {
                            const verified = params.value;
                            if (verified) {
                                return '<span class="px-2.5 py-0.5 rounded text-xs font-semibold uppercase tracking-wide bg-emerald-50 text-emerald-700 border border-emerald-200"><i class="fas fa-check mr-1"></i>VERIFIED</span>';
                            } else {
                                return '<span class="px-2.5 py-0.5 rounded text-xs font-semibold uppercase tracking-wide bg-amber-50 text-amber-700 border border-amber-200"><i class="fas fa-times mr-1"></i>NOT VERIFIED</span>';
                            }
                        }
                    },
                    { 
                        field: 'last_login', 
                        headerName: 'Last Login',
                        filter: 'agDateColumnFilter',
                        sortable: true,
                        editable: false,
                        cellRenderer: (params) => {
                            if (!params.value) return 'Never';
                            return new Date(params.value).toLocaleDateString('en-IN', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    }
                ];

                // Initialize or update grid with editable cells
                if (!usersGridApi) {
                    usersGridApi = window.agGridHelper.initAGGrid('users-grid-container', columnDefs, users, {
                        pagination: true,
                        paginationPageSize: 25,
                        onCellValueChanged: async (params) => {
                            // Save changes when cell is edited
                            if (params.oldValue === params.newValue) return;
                            
                            try {
                                const userId = params.data.user_id;
                                const updateData = {
                                    [params.colDef.field]: params.newValue
                                };
                                
                                await window.updateUser(userId, updateData);
                                
                                // Show success indicator
                                params.node.setDataValue(params.colDef.field, params.newValue);
                            } catch (error) {
                                // Revert on error
                                params.node.setDataValue(params.colDef.field, params.oldValue);
                                alert(`Error updating ${params.colDef.headerName}: ${error.message}`);
                            }
                        }
                    });
                } else {
                    window.agGridHelper.updateGridData(usersGridApi, users);
                }

                loadingEl.classList.add('hidden');
                gridContainer.classList.remove('hidden');
            } catch (error) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Error loading users: ${error.message}`;
            }
        }

        function getRoleColor(role) {
            const colors = {
                'owner': 'purple',
                'admin': 'blue',
                'accountant': 'green',
                'viewer': 'gray'
            };
            return colors[role] || 'gray';
        }

        function showAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
            document.getElementById('add-user-form').reset();
            document.getElementById('add-message').innerHTML = '';
        }

        function hideAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }

        async function editUser(userId) {
            const user = users.find(u => u.user_id === userId);
            if (!user) return;

            document.getElementById('edit-user-id').value = user.user_id;
            document.getElementById('edit-name').value = user.name;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-role').value = user.role;
            document.getElementById('edit-is-active').checked = user.is_active;
            document.getElementById('edit-message').innerHTML = '';
            
            // Show email verification status
            const statusEl = document.getElementById('email-verification-status');
            if (user.email_verified) {
                statusEl.innerHTML = '<span class="text-green-600 text-sm"><i class="fas fa-check-circle mr-1"></i>Email verified</span>';
            } else {
                statusEl.innerHTML = `
                    <div class="flex items-center justify-between bg-yellow-50 border border-yellow-200 rounded p-2">
                        <span class="text-yellow-800 text-sm"><i class="fas fa-exclamation-triangle mr-1"></i>Email not verified</span>
                        ${userId === currentUser.user_id ? `
                            <button onclick="sendVerificationEmailFromModal()" class="text-xs btn-primary py-1 px-2">
                                <i class="fas fa-envelope mr-1"></i>Send Verification
                            </button>
                        ` : '<span class="text-xs text-gray-500">User must verify themselves</span>'}
                    </div>
                `;
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        async function sendVerificationEmailFromModal() {
            try {
                await window.sendVerificationEmail();
                alert('Verification email sent! Please check your inbox.');
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function sendVerificationEmailForUser(userId) {
            try {
                // This would need to be implemented in the API
                // For now, just show a message
                alert('Verification email functionality needs to be implemented in the API');
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        async function deleteUserConfirm(userId) {
            const user = users.find(u => u.user_id === userId);
            if (!user) return;

            if (confirm(`Are you sure you want to deactivate ${user.name}?`)) {
                try {
                    await window.deleteUser(userId);
                    await loadUsers();
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('add-message');
            const btn = e.target.querySelector('button[type="submit"]');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';

            try {
                const data = {
                    name: document.getElementById('add-name').value,
                    email: document.getElementById('add-email').value,
                    role: document.getElementById('add-role').value,
                    send_email: document.getElementById('add-send-email').checked
                };

                await window.createUser(data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">User created successfully!</div>';
                await loadUsers();
                setTimeout(() => {
                    hideAddModal();
                }, 1500);
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus mr-2"></i>Create User';
            }
        });

        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('edit-message');
            const btn = e.target.querySelector('button[type="submit"]');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            try {
                const userId = parseInt(document.getElementById('edit-user-id').value);
                const data = {
                    name: document.getElementById('edit-name').value,
                    role: document.getElementById('edit-role').value,
                    is_active: document.getElementById('edit-is-active').checked
                };

                await window.updateUser(userId, data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">User updated successfully!</div>';
                await loadUsers();
                setTimeout(() => {
                    hideEditModal();
                }, 1500);
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
            }
        });

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            initSidebar('users.html');
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                await window.getCurrentUser();
                await loadUsers();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>

