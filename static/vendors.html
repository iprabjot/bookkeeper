<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper - Vendors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- AG Grid Community Edition -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Vendors</h2>
                        <p class="text-sm text-gray-500" id="company-name-nav">Loading...</p>
                    </div>
                    <button onclick="showAddModal()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Vendor
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <p class="text-sm text-gray-500 mb-4">Vendors are automatically created when purchase invoices are uploaded, or you can add them manually.</p>
                    
                    <div id="vendors-loading" class="flex items-center justify-center h-32">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading vendors...</p>
                        </div>
                    </div>
                    
                    <div id="vendors-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
                    
                    <div id="vendors-grid-container" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Vendor Modal -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Edit Vendor</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="edit-vendor-form" onsubmit="updateVendorForm(event)">
                <input type="hidden" id="edit-vendor-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="edit-vendor-name" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GSTIN *</label>
                        <input type="text" id="edit-vendor-gstin" class="form-input" placeholder="15-character GSTIN" maxlength="15">
                        <div id="gstin-warning" class="mt-2 bg-yellow-50 border border-yellow-200 text-yellow-800 px-3 py-2 rounded text-sm hidden">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Warning:</strong> GSTIN is required for tax compliance. Please add the GSTIN for this vendor.
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="edit-vendor-address" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Info</label>
                        <input type="text" id="edit-vendor-contact" class="form-input" placeholder="Phone, Email">
                    </div>
                </div>
                
                <div class="mt-6 flex gap-3">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Update Vendor
                    </button>
                    <button type="button" onclick="hideEditModal()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="edit-vendor-message" class="mt-4"></div>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div id="add-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Vendor</h3>
                <button onclick="hideAddModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="vendor-form" onsubmit="addVendor(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="vendor-name" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GSTIN</label>
                        <input type="text" id="vendor-gstin" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="vendor-address" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Info</label>
                        <input type="text" id="vendor-contact" class="form-input">
                    </div>
                </div>
                
                <div class="mt-6 flex gap-3">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Add Vendor
                    </button>
                    <button type="button" onclick="hideAddModal()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="vendor-message" class="mt-4"></div>
        </div>
    </div>

    <script src="/static/api.js"></script>
    <script src="/static/sidebar.js"></script>
    <script src="/static/ag-grid-helper.js"></script>
    <script>
        let vendorsGridApi = null;

        async function loadVendors() {
            const loadingEl = document.getElementById('vendors-loading');
            const errorEl = document.getElementById('vendors-error');
            const gridContainer = document.getElementById('vendors-grid-container');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            gridContainer.classList.add('hidden');
            
            try {
                const vendors = await window.getVendors();
                
                // Define column definitions with editable cells
                const columnDefs = [
                    { 
                        field: 'name', 
                        headerName: 'Name',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor'
                    },
                    { 
                        field: 'gstin', 
                        headerName: 'GSTIN',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor',
                        cellRenderer: (params) => {
                            if (!params.value || params.value.trim() === '') {
                                return '<span class="text-red-600 font-semibold">⚠️ Missing</span>';
                            }
                            return params.value;
                        },
                        cellStyle: (params) => {
                            if (!params.value || params.value.trim() === '') {
                                return { backgroundColor: '#fef3c7' }; // Yellow background for missing GSTIN
                            }
                            return null;
                        }
                    },
                    { 
                        field: 'address', 
                        headerName: 'Address',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 2,
                        cellEditor: 'agLargeTextCellEditor',
                        cellEditorParams: {
                            maxLength: 500,
                            rows: 3,
                            cols: 50
                        },
                        cellRenderer: (params) => {
                            return params.value || '-';
                        }
                    },
                    { 
                        field: 'contact_info', 
                        headerName: 'Contact',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor',
                        cellRenderer: (params) => {
                            return params.value || '-';
                        }
                    },
                    { 
                        field: 'created_at', 
                        headerName: 'Created',
                        filter: 'agDateColumnFilter',
                        sortable: true,
                        editable: false,
                        cellRenderer: (params) => {
                            if (!params.value) return '-';
                            return new Date(params.value).toLocaleDateString('en-IN', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    }
                ];

                // Initialize or update grid
                if (!vendorsGridApi) {
                    vendorsGridApi = window.agGridHelper.initAGGrid('vendors-grid-container', columnDefs, vendors, {
                        pagination: true,
                        paginationPageSize: 25,
                        onCellValueChanged: async (params) => {
                            // Save changes when cell is edited
                            if (params.oldValue === params.newValue) return;
                            
                            try {
                                const vendorId = params.data.vendor_id;
                                const updateData = {
                                    [params.colDef.field]: params.newValue || null
                                };
                                
                                await window.updateVendor(vendorId, updateData);
                                
                                // Show success indicator
                                params.node.setDataValue(params.colDef.field, params.newValue);
                                
                                // Reload to update GSTIN warning styling
                                if (params.colDef.field === 'gstin') {
                                    await loadVendors();
                                }
                            } catch (error) {
                                // Revert on error
                                params.node.setDataValue(params.colDef.field, params.oldValue);
                                alert(`Error updating ${params.colDef.headerName}: ${error.message}`);
                            }
                        }
                    });
                } else {
                    window.agGridHelper.updateGridData(vendorsGridApi, vendors);
                }
                
                loadingEl.classList.add('hidden');
                errorEl.classList.add('hidden');
                gridContainer.classList.remove('hidden');
            } catch (error) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Error loading vendors: ${error.message}`;
            }
        }

        function showAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function hideAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('vendor-form').reset();
            document.getElementById('vendor-message').innerHTML = '';
        }

        async function addVendor(event) {
            event.preventDefault();
            const messageEl = document.getElementById('vendor-message');
            
            const data = {
                name: document.getElementById('vendor-name').value,
                gstin: document.getElementById('vendor-gstin').value || null,
                address: document.getElementById('vendor-address').value || null,
                contact_info: document.getElementById('vendor-contact').value || null
            };
            
            try {
                await window.createVendor(data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"> Vendor added successfully!</div>';
                hideAddModal();
                loadVendors();
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"> Error: ${error.message}</div>`;
            }
        }

        function showEditModal(vendorId, name, gstin, address, contact) {
            document.getElementById('edit-vendor-id').value = vendorId;
            document.getElementById('edit-vendor-name').value = name;
            document.getElementById('edit-vendor-gstin').value = gstin;
            document.getElementById('edit-vendor-address').value = address;
            document.getElementById('edit-vendor-contact').value = contact;
            
            // Show/hide GSTIN warning
            const gstinWarning = document.getElementById('gstin-warning');
            if (!gstin || gstin.trim() === '') {
                gstinWarning.classList.remove('hidden');
            } else {
                gstinWarning.classList.add('hidden');
            }
            
            // Update warning visibility on GSTIN input change
            const gstinInput = document.getElementById('edit-vendor-gstin');
            // Remove any existing listeners by cloning the element
            const newGstinInput = gstinInput.cloneNode(true);
            gstinInput.parentNode.replaceChild(newGstinInput, gstinInput);
            
            newGstinInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    gstinWarning.classList.remove('hidden');
                } else {
                    gstinWarning.classList.add('hidden');
                }
            });
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-vendor-form').reset();
            document.getElementById('edit-vendor-message').innerHTML = '';
        }

        async function updateVendorForm(event) {
            event.preventDefault();
            const messageEl = document.getElementById('edit-vendor-message');
            const vendorId = document.getElementById('edit-vendor-id').value;
            
            const data = {
                name: document.getElementById('edit-vendor-name').value,
                gstin: document.getElementById('edit-vendor-gstin').value || null,
                address: document.getElementById('edit-vendor-address').value || null,
                contact_info: document.getElementById('edit-vendor-contact').value || null
            };
            
            try {
                await window.updateVendor(vendorId, data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"> Vendor updated successfully!</div>';
                setTimeout(() => {
                    hideEditModal();
                    loadVendors();
                }, 1000);
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"> Error: ${error.message}</div>`;
            }
        }

        async function loadCompanyName() {
            try {
                const company = await window.getCurrentCompany();
                document.getElementById('company-name-nav').textContent = company.name;
            } catch (error) {
                document.getElementById('company-name-nav').textContent = 'No company set';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSidebar('vendors.html');
            loadCompanyName();
            loadVendors();
        });
    </script>
</body>
</html>
