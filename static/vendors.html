<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper - Vendors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Vendors</h2>
                        <p class="text-sm text-gray-500" id="company-name-nav">Loading...</p>
                    </div>
                    <button onclick="showAddModal()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Vendor
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <p class="text-sm text-gray-500 mb-4">Vendors are automatically created when purchase invoices are uploaded, or you can add them manually.</p>
                    
                    <div id="vendors-loading" class="flex items-center justify-center h-32">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading vendors...</p>
                        </div>
                    </div>
                    
                    <div id="vendors-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
                    
                    <div class="table-container hidden" id="vendors-table-container">
                        <table id="vendors-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>GSTIN</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vendors-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Vendor Modal -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Edit Vendor</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="edit-vendor-form" onsubmit="updateVendor(event)">
                <input type="hidden" id="edit-vendor-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="edit-vendor-name" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GSTIN *</label>
                        <input type="text" id="edit-vendor-gstin" class="form-input" placeholder="15-character GSTIN" maxlength="15">
                        <div id="gstin-warning" class="mt-2 bg-yellow-50 border border-yellow-200 text-yellow-800 px-3 py-2 rounded text-sm hidden">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Warning:</strong> GSTIN is required for tax compliance. Please add the GSTIN for this vendor.
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="edit-vendor-address" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Info</label>
                        <input type="text" id="edit-vendor-contact" class="form-input" placeholder="Phone, Email">
                    </div>
                </div>
                
                <div class="mt-6 flex gap-3">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Update Vendor
                    </button>
                    <button type="button" onclick="hideEditModal()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="edit-vendor-message" class="mt-4"></div>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div id="add-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Vendor</h3>
                <button onclick="hideAddModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="vendor-form" onsubmit="addVendor(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="vendor-name" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GSTIN</label>
                        <input type="text" id="vendor-gstin" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="vendor-address" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Info</label>
                        <input type="text" id="vendor-contact" class="form-input">
                    </div>
                </div>
                
                <div class="mt-6 flex gap-3">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Add Vendor
                    </button>
                    <button type="button" onclick="hideAddModal()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="vendor-message" class="mt-4"></div>
        </div>
    </div>

    <script src="/static/api.js"></script>
    <script src="/static/sidebar.js"></script>
    <script>
        async function loadVendors() {
            const loadingEl = document.getElementById('vendors-loading');
            const errorEl = document.getElementById('vendors-error');
            const tableContainer = document.getElementById('vendors-table-container');
            const tbodyEl = document.getElementById('vendors-tbody');
            
            try {
                const vendors = await window.getVendors();
                
                if (vendors.length === 0) {
                    tbodyEl.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No vendors found. Add one to get started.</td></tr>';
                } else {
                    tbodyEl.innerHTML = vendors.map(vendor => {
                        const date = new Date(vendor.created_at).toLocaleDateString('en-IN');
                        const hasGstin = vendor.gstin && vendor.gstin.trim() !== '';
                        const gstinDisplay = hasGstin ? vendor.gstin : `<span class="text-red-600 font-semibold">⚠️ Missing</span>`;
                        
                        return `
                            <tr class="${!hasGstin ? 'bg-yellow-50' : ''}">
                                <td class="font-medium">${vendor.name}</td>
                                <td>${gstinDisplay}</td>
                                <td>${vendor.address || '-'}</td>
                                <td>${vendor.contact_info || '-'}</td>
                                <td>${date}</td>
                                <td>
                                    <button onclick="showEditModal(${vendor.vendor_id}, '${vendor.name.replace(/'/g, "\\'")}', '${(vendor.gstin || '').replace(/'/g, "\\'")}', '${(vendor.address || '').replace(/'/g, "\\'")}', '${(vendor.contact_info || '').replace(/'/g, "\\'")}')" 
                                            class="text-blue-600 hover:text-blue-800" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                loadingEl.classList.add('hidden');
                errorEl.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            } catch (error) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Error loading vendors: ${error.message}`;
            }
        }

        function showAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function hideAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('vendor-form').reset();
            document.getElementById('vendor-message').innerHTML = '';
        }

        async function addVendor(event) {
            event.preventDefault();
            const messageEl = document.getElementById('vendor-message');
            
            const data = {
                name: document.getElementById('vendor-name').value,
                gstin: document.getElementById('vendor-gstin').value || null,
                address: document.getElementById('vendor-address').value || null,
                contact_info: document.getElementById('vendor-contact').value || null
            };
            
            try {
                await window.createVendor(data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"> Vendor added successfully!</div>';
                hideAddModal();
                loadVendors();
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"> Error: ${error.message}</div>`;
            }
        }

        function showEditModal(vendorId, name, gstin, address, contact) {
            document.getElementById('edit-vendor-id').value = vendorId;
            document.getElementById('edit-vendor-name').value = name;
            document.getElementById('edit-vendor-gstin').value = gstin;
            document.getElementById('edit-vendor-address').value = address;
            document.getElementById('edit-vendor-contact').value = contact;
            
            // Show/hide GSTIN warning
            const gstinWarning = document.getElementById('gstin-warning');
            if (!gstin || gstin.trim() === '') {
                gstinWarning.classList.remove('hidden');
            } else {
                gstinWarning.classList.add('hidden');
            }
            
            // Update warning visibility on GSTIN input change
            const gstinInput = document.getElementById('edit-vendor-gstin');
            // Remove any existing listeners by cloning the element
            const newGstinInput = gstinInput.cloneNode(true);
            gstinInput.parentNode.replaceChild(newGstinInput, gstinInput);
            
            newGstinInput.addEventListener('input', function() {
                if (this.value.trim() === '') {
                    gstinWarning.classList.remove('hidden');
                } else {
                    gstinWarning.classList.add('hidden');
                }
            });
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-vendor-form').reset();
            document.getElementById('edit-vendor-message').innerHTML = '';
        }

        async function updateVendor(event) {
            event.preventDefault();
            const messageEl = document.getElementById('edit-vendor-message');
            const vendorId = document.getElementById('edit-vendor-id').value;
            
            const data = {
                name: document.getElementById('edit-vendor-name').value,
                gstin: document.getElementById('edit-vendor-gstin').value || null,
                address: document.getElementById('edit-vendor-address').value || null,
                contact_info: document.getElementById('edit-vendor-contact').value || null
            };
            
            try {
                await window.updateVendor(vendorId, data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"> Vendor updated successfully!</div>';
                setTimeout(() => {
                    hideEditModal();
                    loadVendors();
                }, 1000);
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"> Error: ${error.message}</div>`;
            }
        }

        async function loadCompanyName() {
            try {
                const company = await window.getCurrentCompany();
                document.getElementById('company-name-nav').textContent = company.name;
            } catch (error) {
                document.getElementById('company-name-nav').textContent = 'No company set';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSidebar('vendors.html');
            loadCompanyName();
            loadVendors();
        });
    </script>
</body>
</html>
