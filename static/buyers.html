<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookkeeper - Buyers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <!-- AG Grid Community Edition -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900">Buyers</h2>
                        <p class="text-sm text-gray-500" id="company-name-nav">Loading...</p>
                    </div>
                    <button onclick="showAddModal()" class="btn-primary">
                        <i class="fas fa-plus mr-2"></i>Add Buyer
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <p class="text-sm text-gray-500 mb-4">Buyers are automatically created when sales invoices are uploaded, or you can add them manually.</p>
                    
                    <div id="buyers-loading" class="flex items-center justify-center h-32">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-500">Loading buyers...</p>
                        </div>
                    </div>
                    
                    <div id="buyers-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
                    
                    <div id="buyers-grid-container" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Buyer Modal -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Edit Buyer</h3>
                <button onclick="hideEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="edit-buyer-form" onsubmit="updateBuyerForm(event)">
                <input type="hidden" id="edit-buyer-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="edit-buyer-name" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GSTIN</label>
                        <input type="text" id="edit-buyer-gstin" class="form-input" placeholder="15-character GSTIN">
                        <p class="text-xs text-gray-500 mt-1">Important: GSTIN is required for tax compliance.</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="edit-buyer-address" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Info</label>
                        <input type="text" id="edit-buyer-contact" class="form-input" placeholder="Phone, Email">
                    </div>
                </div>
                
                <div class="mt-6 flex gap-3">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Update Buyer
                    </button>
                    <button type="button" onclick="hideEditModal()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="edit-buyer-message" class="mt-4"></div>
        </div>
    </div>

    <!-- Add Buyer Modal -->
    <div id="add-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Buyer</h3>
                <button onclick="hideAddModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="buyer-form" onsubmit="addBuyer(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="buyer-name" class="form-input" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GSTIN</label>
                        <input type="text" id="buyer-gstin" class="form-input">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="buyer-address" class="form-input" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Info</label>
                        <input type="text" id="buyer-contact" class="form-input">
                    </div>
                </div>
                
                <div class="mt-6 flex gap-3">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Add Buyer
                    </button>
                    <button type="button" onclick="hideAddModal()" class="btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
            
            <div id="buyer-message" class="mt-4"></div>
        </div>
    </div>

    <script src="/static/api.js"></script>
    <script src="/static/sidebar.js"></script>
    <script src="/static/ag-grid-helper.js"></script>
    <script>
        let buyersGridApi = null;

        async function loadBuyers() {
            const loadingEl = document.getElementById('buyers-loading');
            const errorEl = document.getElementById('buyers-error');
            const gridContainer = document.getElementById('buyers-grid-container');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            gridContainer.classList.add('hidden');
            
            try {
                const buyers = await window.getBuyers();
                
                // Define column definitions with editable cells
                const columnDefs = [
                    { 
                        field: 'name', 
                        headerName: 'Name',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor'
                    },
                    { 
                        field: 'gstin', 
                        headerName: 'GSTIN',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor',
                        cellRenderer: (params) => {
                            return params.value || '-';
                        }
                    },
                    { 
                        field: 'address', 
                        headerName: 'Address',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 2,
                        cellEditor: 'agLargeTextCellEditor',
                        cellEditorParams: {
                            maxLength: 500,
                            rows: 3,
                            cols: 50
                        },
                        cellRenderer: (params) => {
                            return params.value || '-';
                        }
                    },
                    { 
                        field: 'contact_info', 
                        headerName: 'Contact',
                        filter: 'agTextColumnFilter',
                        sortable: true,
                        editable: true,
                        flex: 1,
                        cellEditor: 'agTextCellEditor',
                        cellRenderer: (params) => {
                            return params.value || '-';
                        }
                    },
                    { 
                        field: 'created_at', 
                        headerName: 'Created',
                        filter: 'agDateColumnFilter',
                        sortable: true,
                        editable: false,
                        cellRenderer: (params) => {
                            if (!params.value) return '-';
                            return new Date(params.value).toLocaleDateString('en-IN', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    }
                ];

                // Initialize or update grid
                if (!buyersGridApi) {
                    buyersGridApi = window.agGridHelper.initAGGrid('buyers-grid-container', columnDefs, buyers, {
                        pagination: true,
                        paginationPageSize: 25,
                        onCellValueChanged: async (params) => {
                            // Save changes when cell is edited
                            if (params.oldValue === params.newValue) return;
                            
                            try {
                                const buyerId = params.data.buyer_id;
                                const updateData = {
                                    [params.colDef.field]: params.newValue || null
                                };
                                
                                await window.updateBuyer(buyerId, updateData);
                                
                                // Show success indicator
                                params.node.setDataValue(params.colDef.field, params.newValue);
                            } catch (error) {
                                // Revert on error
                                params.node.setDataValue(params.colDef.field, params.oldValue);
                                alert(`Error updating ${params.colDef.headerName}: ${error.message}`);
                            }
                        }
                    });
                } else {
                    window.agGridHelper.updateGridData(buyersGridApi, buyers);
                }
                
                loadingEl.classList.add('hidden');
                errorEl.classList.add('hidden');
                gridContainer.classList.remove('hidden');
            } catch (error) {
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorEl.textContent = `Error loading buyers: ${error.message}`;
            }
        }

        function showAddModal() {
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function hideAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
            document.getElementById('buyer-form').reset();
            document.getElementById('buyer-message').innerHTML = '';
        }

        async function addBuyer(event) {
            event.preventDefault();
            const messageEl = document.getElementById('buyer-message');
            
            const data = {
                name: document.getElementById('buyer-name').value,
                gstin: document.getElementById('buyer-gstin').value || null,
                address: document.getElementById('buyer-address').value || null,
                contact_info: document.getElementById('buyer-contact').value || null
            };
            
            try {
                await window.createBuyer(data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"> Buyer added successfully!</div>';
                hideAddModal();
                loadBuyers();
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"> Error: ${error.message}</div>`;
            }
        }

        function showEditModal(buyerId, name, gstin, address, contact) {
            document.getElementById('edit-buyer-id').value = buyerId;
            document.getElementById('edit-buyer-name').value = name;
            document.getElementById('edit-buyer-gstin').value = gstin;
            document.getElementById('edit-buyer-address').value = address;
            document.getElementById('edit-buyer-contact').value = contact;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-buyer-form').reset();
            document.getElementById('edit-buyer-message').innerHTML = '';
        }

        async function updateBuyerForm(event) {
            event.preventDefault();
            const messageEl = document.getElementById('edit-buyer-message');
            const buyerId = document.getElementById('edit-buyer-id').value;
            
            const data = {
                name: document.getElementById('edit-buyer-name').value,
                gstin: document.getElementById('edit-buyer-gstin').value || null,
                address: document.getElementById('edit-buyer-address').value || null,
                contact_info: document.getElementById('edit-buyer-contact').value || null
            };
            
            try {
                await window.updateBuyer(buyerId, data);
                messageEl.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"> Buyer updated successfully!</div>';
                setTimeout(() => {
                    hideEditModal();
                    loadBuyers();
                }, 1000);
            } catch (error) {
                messageEl.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"> Error: ${error.message}</div>`;
            }
        }

        async function loadCompanyName() {
            try {
                const company = await window.getCurrentCompany();
                document.getElementById('company-name-nav').textContent = company.name;
            } catch (error) {
                document.getElementById('company-name-nav').textContent = 'No company set';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSidebar('buyers.html');
            loadCompanyName();
            loadBuyers();
        });
    </script>
</body>
</html>
